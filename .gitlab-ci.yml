####
# GitLab CI
####

# Image
image: ubuntu:24.04

# Stages
stages:
  - build
  - publish

# Build
Assemble:
  stage: build
  artifacts:
    paths:
      - dist/
  script:
  # Packages
  - cd $CI_PROJECT_DIR
  - apt-get update && apt-get install -y build-essential curl git libgeoip-dev libgmp-dev zlib1g-dev libcurl4-gnutls-dev cmake libbz2-dev
  - mkdir -p dist/bin-static dist/bin-shared
  - curl https://raw.githubusercontent.com/lep/jassdoc/master/Blizzard.j > "mapcfgs/blizzard.j"
  - curl https://raw.githubusercontent.com/lep/jassdoc/master/common.j > "mapcfgs/common.j"
  # BNCSUtil (dynamic, .so)
  - cd $CI_PROJECT_DIR
  - cd bncsutil/src/bncsutil
  - export BNCSUTIL_SHARED_LIB=1
  - make && make install
  - unset BNCSUTIL_SHARED_LIB
  - cd $CI_PROJECT_DIR
  ## Shared library
  - cp /usr/lib/libbncsutil.so /usr/local/lib
  - cp /usr/lib/libbncsutil.so* dist/bin-shared
  ## Header files
  ### - cp -R /usr/include/bncsutil dist/include
  # StormLib (shared, .so)
  - cd $CI_PROJECT_DIR
  - cd StormLib
  #- sed -i -e 's/option(BUILD_SHARED_LIBS "Compile shared libraries" OFF)/option(BUILD_SHARED_LIBS "Compile shared libraries" ON)/g' CMakeLists.txt
  - rm -rf build && mkdir -p build
  - cd build && cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=1 ..
  - make && make install
  - cd $CI_PROJECT_DIR
  ## Shared library
  ### Already at /usr/local/lib
  ### - cp /usr/local/lib/libstorm.so /usr/local/lib
  - cp /usr/local/lib/libstorm.so* dist/bin-shared
  ## Header files
  ### - cp /usr/local/include/StormLib.h dist/include/stormlib
  ### - cp /usr/local/include/StormPort.h dist/include/stormlib
  # MiniUPNP (shared, .so)
  - cd $CI_PROJECT_DIR
  - cd miniupnpc
  - make && make install
  - cd $CI_PROJECT_DIR
  ## Shared library
  - cp /usr/lib/libminiupnpc.so /usr/local/lib
  - cp /usr/lib/libminiupnpc.so* dist/bin-shared
  # Aura (all shared libraries)
  - cd $CI_PROJECT_DIR
  - export AURALINKMINIUPNP=1
  - export AURALINKCPR=0
  - make && make install
  - unset AURALINKMINIUPNP
  - unset AURALINKCPR
  ## on static build failures, the error is reported iff mv below fails
  - mv /usr/bin/aura dist/bin-shared
  - cd dist/bin-shared
  - chmod +x aura
  - chmod +x *.so
  - chmod +x *.so.*
  - export LD_LIBRARY_PATH=$CI_PROJECT_DIR/dist/bin-shared
  - ./aura --stdpaths --config="../../config-example.ini" --no-bnet --w3version=27 --cfgdir="../../mapcfgs" --timeout=1 --auto-port-forward --check-joinable --verbose "../../mapcfgs/wormwar.cfg"
  - unset LD_LIBRARY_PATH
  ######################
  ### Static build     #
  ######################
  # BNCSUtil (static, .a)
  ## FIXME
  - cd $CI_PROJECT_DIR
  - cd bncsutil/src/bncsutil
  - export BNCSUTIL_STATIC_LIB=1
  - make && make install
  - unset BNCSUTIL_STATIC_LIB
  - cd $CI_PROJECT_DIR
  ## Shared library
  - cp /usr/lib/libbncsutil.so /usr/local/lib
  - cp /usr/lib/libbncsutil.so* dist/bin-shared
  ## Header files
  ### - cp -R /usr/include/bncsutil dist/include
  # StormLib (static, .a)
  - cd $CI_PROJECT_DIR
  - cd StormLib
  #- sed -i -e 's/option(BUILD_SHARED_LIBS "Compile shared libraries" ON)/option(BUILD_SHARED_LIBS "Compile shared libraries" OFF)/g' CMakeLists.txt
  - rm -rf build && mkdir -p build
  - cd build && cmake -DCMAKE_BUILD_TYPE=Release ..
  - make clean && make && make install
  - cd $CI_PROJECT_DIR
  ## Static library
  ### Already at /usr/local/lib
  ### - cp /usr/local/lib/libstorm.a /usr/local/lib
  - cp /usr/local/lib/libstorm.a dist/bin-static
  ## Header files
  ### - cp /usr/local/include/StormLib.h dist/include/stormlib
  ### - cp /usr/local/include/StormPort.h dist/include/stormlib
  # MiniUPNP (static, .a)
  - cd $CI_PROJECT_DIR
  - cd miniupnpc
  - export CPPFLAGS="-DMINIUPNP_STATICLIB"
  - make clean && make && make install
  - unset CPPFLAGS
  - cd $CI_PROJECT_DIR
  ## Static library
  - cp /usr/lib/libminiupnpc.a /usr/local/lib
  - cp /usr/lib/libminiupnpc.a dist/bin-static
  ### - cp /usr/lib/libminiupnpc.a dist/lib
  # Aura (all static libraries)
  - cd $CI_PROJECT_DIR
  #- export AURALINKMINIUPNP=0
  - export AURALINKCPR=0
  - export AURASTATIC=1
  - make clean && make && make install
  - unset AURALINKCPR
  - unset AURASTATIC
  ## on static build failures, the error is reported iff mv below fails
  ## touch causes mv to succeed: static build is unsupported yet
  - touch /usr/bin/aura
  - mv /usr/bin/aura dist/bin-static
  - chmod +x dist/bin-static/aura
